---
title: "Portfolio Optimization with Domain Knowledge"
author: "Mustafa M. Ali"
subtitle: 'Dec. 18, 2025'
execute:
  eval: false
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
sansfont: Georgia
mainfont: Georgia
format: pdf
---

\vspace{0.25cm}

```{r, warning=FALSE, error=FALSE}
#install.packages("quantmod")
library(quantmod)
library(tidyverse)
library(patchwork)
library(ggridges)
library(tidymodels)
library(ggrepel)
library(readr)
theme_set(theme_bw())

companies_df <- read_csv("Data/sp500_companies.csv") |> na.omit()
index_df <- read_csv("Data/sp500_index.csv") |> na.omit()
stocks_df <- read_csv("Data/sp500_stocks.csv") |> na.omit()

companies_df
index_df
stocks_df |> distinct(Symbol) |> arrange(Symbol)
```


```{r}
names(companies_df[c(-15)])

econSimilarity_df <- data.frame()

for (row1 in 1:nrow(companies_df)){
  for (row2 in 1:nrow(companies_df)){
    if (companies_df[row1, "Symbol"] != companies_df[row2, "Symbol"]) {
      if (companies_df[row1, "Sector"] == companies_df[row2, "Sector"] & companies_df[row1, "Industry"] == companies_df[row2, "Industry"]) {
        econSimilarity_df <- econSimilarity_df |> rbind(data.frame(Ticker1 = companies_df[row1, "Symbol"], Ticker2 = companies_df[row2, "Symbol"], EconSimilarity = 0.7))
      } else if (companies_df[row1, "Sector"] == companies_df[row2, "Sector"]) { # industries are different, but sectors are the same
        econSimilarity_df <- econSimilarity_df |> rbind(data.frame(Ticker1 = companies_df[row1, "Symbol"], Ticker2 = companies_df[row2, "Symbol"], EconSimilarity = 0.3))
      }
    }
  }
}
econSimilarity_df <- econSimilarity_df |> rename(Ticker1=Symbol, Ticker2=Symbol.1)
econSimilarity_df
```


## Retrieve financial information
For all the companies we can, we will obtain things like moving averages, market cap, P/E ratio, etc.

```{r}
#Problematic tickers: 200, 252, 399, 431, 436
tickers <- unique(companies_df$Symbol[-c(200, 252, 399, 431, 436)])
companies_quote <- getQuote(tickers, what = yahooQF(c("Symbol", "Previous Close", "52-week Low", "52-week High", "50-day Moving Average", "200-day Moving Average", "Market Capitalization", "P/E Ratio", "Price/Book")))
companies_quote <- companies_quote |> na.omit()
```


## Scaling
This dataframe will be used to create another similarity metric using Euclidean distance.
Numeric columns will be scaled using z-score.
Also, if any of the columns other than Market cap are more than 3 standard deviations away from the mean,
it could indicate overvaluing or undervaluing of a company, so we remove those outliers.

```{r}
companies_quote$`Market Capitalization` <- log10(companies_quote$`Market Capitalization`) #Results in less extreme scaling
scale_minmax <- function(x) { #You can use this instead of scale() if u want :)
  return((x - min(x)) / (max(x) - min(x)))
}
scaled_companies_quote <- companies_quote |> mutate(across(where(is.numeric), ~scale(.x)))
scaled_companies_quote <- scaled_companies_quote |> filter(if_all(-c(`Trade Time`, Symbol, `Market Capitalization`), ~ (.x >= -3 & .x <= 3)))
```


## Euclidean distance
```{r}
finSimilarity_df <- data.frame()
cosine_sim <- function(A, B) {
  return(sum(A*B) / (sqrt(sum(A^2)) * sqrt(sum(B^2))))
}

for (row1 in 1:nrow(scaled_companies_quote)){
  for (row2 in 1:nrow(scaled_companies_quote)){
    if (scaled_companies_quote[row1, "Symbol"] != scaled_companies_quote[row2, "Symbol"]) {
      val1 = dist(scaled_companies_quote[c(row1, row2),3:ncol(scaled_companies_quote)])
      val2 = cosine_sim(scaled_companies_quote[row1,3:ncol(scaled_companies_quote)], scaled_companies_quote[row1,3:ncol(scaled_companies_quote)])
      finSimilarity_df <- finSimilarity_df |> rbind(data.frame(Ticker1 = scaled_companies_quote[row1, "Symbol"], Ticker2 = scaled_companies_quote[row2, "Symbol"], euclDist = val1, cosiSim = val2))
    }
  }
}

finSimilarity_df |> rename(Ticker1=Symbol, Ticker2=Symbol.1)
```


## Cosine similarity
```{r}


```















